/*! WP User Manager - v0.1.0
 * http://wp-user-manager.com
 * Copyright (c) 2015; * Licensed GPLv2+ */
!function(a){"use strict";a.fn.serializeJSON=function(b){var c,d,e,f,g,h,i;return h=a.serializeJSON,i=h.optsWithDefaults(b),h.validateOptions(i),d=this.serializeArray(),h.readCheckboxUncheckedValues(d,this,i),c={},a.each(d,function(a,b){e=h.splitInputNameIntoKeysArray(b.name),f=e.pop(),"skip"!==f&&(g=h.parseValue(b.value,f,i),i.parseWithFunction&&"_"===f&&(g=i.parseWithFunction(g,b.name)),h.deepSet(c,e,g,i))}),c},a.serializeJSON={defaultOptions:{parseNumbers:!1,parseBooleans:!1,parseNulls:!1,parseAll:!1,parseWithFunction:null,checkboxUncheckedValue:void 0,useIntKeysAsArrayIndex:!1},optsWithDefaults:function(b){var c,d;return null==b&&(b={}),c=a.serializeJSON,d=c.optWithDefaults("parseAll",b),{parseNumbers:d||c.optWithDefaults("parseNumbers",b),parseBooleans:d||c.optWithDefaults("parseBooleans",b),parseNulls:d||c.optWithDefaults("parseNulls",b),parseWithFunction:c.optWithDefaults("parseWithFunction",b),checkboxUncheckedValue:c.optWithDefaults("checkboxUncheckedValue",b),useIntKeysAsArrayIndex:c.optWithDefaults("useIntKeysAsArrayIndex",b)}},optWithDefaults:function(b,c){return c[b]!==!1&&""!==c[b]&&(c[b]||a.serializeJSON.defaultOptions[b])},validateOptions:function(a){var b,c;c=["parseNumbers","parseBooleans","parseNulls","parseAll","parseWithFunction","checkboxUncheckedValue","useIntKeysAsArrayIndex"];for(b in a)if(-1===c.indexOf(b))throw new Error("serializeJSON ERROR: invalid option '"+b+"'. Please use one of "+c.join(","))},parseValue:function(b,c,d){var e;return e=a.serializeJSON,"string"==c?b:"number"==c||d.parseNumbers&&e.isNumeric(b)?Number(b):"boolean"==c||d.parseBooleans&&("true"===b||"false"===b)?-1===["false","null","undefined","","0"].indexOf(b):"null"==c||d.parseNulls&&"null"==b?-1!==["false","null","undefined","","0"].indexOf(b)?null:b:"array"==c||"object"==c?JSON.parse(b):"auto"==c?e.parseValue(b,null,{parseNumbers:!0,parseBooleans:!0,parseNulls:!0}):b},isObject:function(a){return a===Object(a)},isUndefined:function(a){return void 0===a},isValidArrayIndex:function(a){return/^[0-9]+$/.test(String(a))},isNumeric:function(a){return a-parseFloat(a)>=0},splitInputNameIntoKeysArray:function(b){var c,d,e,f,g;return g=a.serializeJSON,f=g.extractTypeFromInputName(b),d=f[0],e=f[1],c=d.split("["),c=a.map(c,function(a){return a.replace(/]/g,"")}),""===c[0]&&c.shift(),c.push(e),c},extractTypeFromInputName:function(b){var c,d;if(d=a.serializeJSON,c=b.match(/(.*):([^:]+)$/)){var e=["string","number","boolean","null","array","object","skip","auto"];if(-1!==e.indexOf(c[2]))return[c[1],c[2]];throw new Error("serializeJSON ERROR: Invalid type "+c[2]+" found in input name '"+b+"', please use one of "+e.join(", "))}return[b,"_"]},deepSet:function(b,c,d,e){var f,g,h,i,j,k;if(null==e&&(e={}),k=a.serializeJSON,k.isUndefined(b))throw new Error("ArgumentError: param 'o' expected to be an object or array, found undefined");if(!c||0===c.length)throw new Error("ArgumentError: param 'keys' expected to be an array with least one element");f=c[0],1===c.length?""===f?b.push(d):b[f]=d:(g=c[1],""===f&&(i=b.length-1,j=b[i],f=k.isObject(j)&&(k.isUndefined(j[g])||c.length>2)?i:i+1),""===g?(k.isUndefined(b[f])||!a.isArray(b[f]))&&(b[f]=[]):e.useIntKeysAsArrayIndex&&k.isValidArrayIndex(g)?(k.isUndefined(b[f])||!a.isArray(b[f]))&&(b[f]=[]):(k.isUndefined(b[f])||!k.isObject(b[f]))&&(b[f]={}),h=c.slice(1),k.deepSet(b[f],h,d,e))},readCheckboxUncheckedValues:function(b,c,d){var e,f,g,h,i;null==d&&(d={}),i=a.serializeJSON,e="input[type=checkbox][name]:not(:checked):not([disabled])",f=c.find(e).add(c.filter(e)),f.each(function(c,e){g=a(e),h=g.attr("data-unchecked-value"),h?b.push({name:e.name,value:h}):i.isUndefined(d.checkboxUncheckedValue)||b.push({name:e.name,value:d.checkboxUncheckedValue})})}}}(window.jQuery||window.Zepto||window.$),jQuery(document).ready(function(a){var b={init:function(){this.general(),this.restore_emails(),this.order_default_fields(),this.restore_default_fields(),this.custom_fields_editor()},general:function(){jQuery(".select2, .wppf-multiselect").select2()},restore_emails:function(){a("#wpum-restore-emails").on("click",function(b){if(b.preventDefault(),!confirm(wpum_admin_js.confirm))return!1;var c=a("#wpum_backend_security").val();a.ajax({type:"GET",dataType:"json",url:wpum_admin_js.ajax,data:{action:"wpum_restore_emails",wpum_backend_security:c},beforeSend:function(){a(".wpum-spinner").hide(),a(".wpum-ajax-done-message").hide(),a("#wpum-restore-emails").after('<span id="wpum-spinner" class="spinner wpum-spinner"></span>')},success:function(b){a("#wpum-restore-emails").after('<p class="wpum-ajax-done-message"> <span class="dashicons dashicons-yes"></span> '+b.data.message+"</p>"),a(".wpum-spinner").hide()},error:function(a){alert(a.responseText)}})})},order_default_fields:function(){a.isFunction(a.fn.sortable)&&a(".users_page_wpum-custom-fields-editor tbody").sortable({helper:this.sortable_table_fix,axis:"y",cursor:"pointer",opacity:.5,placeholder:"row-dragging",delay:150,handle:".column-order, .move-field",update:function(){a(this).children("tr").each(function(){a(this).children("td:first-child").html(a(this).index()),a(this).data("priority",a(this).index())}),dataArray=a.map(a(this).children("tr"),function(b){return{priority:a(b).data("priority"),meta:a(b).data("meta"),required:a(b).data("required"),show_on_signup:a(b).data("show_on_signup")}});var b=a("#_wpnonce").val();a.ajax({type:"POST",dataType:"json",url:wpum_admin_js.ajax,data:{action:"wpum_update_fields_order",items:dataArray,wpum_editor_nonce:b},beforeSend:function(){a("#setting-error-").remove();var b=a(".wp-list-table").height();a(".wpum-table-loader").css("display","table"),a(".wpum-table-loader").css("height",b)},success:function(b){a(".users_page_wpum-custom-fields-editor").find("tr").removeClass("alternate"),a(".users_page_wpum-custom-fields-editor").find("tr:even").addClass("alternate"),a(".wpum-table-loader").hide(),a(".wpum-page-title").after('<div id="setting-error-" class="updated settings-error"><p><strong>'+b.data.message+"</strong></p></div>")},error:function(a){alert(a.responseText)}})}}).disableSelection()},sortable_table_fix:function(b,c){var d=c.children(),e=c.clone();return e.children().each(function(b){a(this).width(d.eq(b).width())}),e},restore_default_fields:function(){a("#wpum-restore-default-fields").on("click",function(b){if(b.preventDefault(),!confirm(wpum_admin_js.confirm))return!1;var c=a("#wpum_backend_fields_restore").val();a.ajax({type:"GET",dataType:"json",url:wpum_admin_js.ajax,data:{action:"wpum_restore_default_fields",wpum_backend_fields_restore:c},beforeSend:function(){a(".wpum-spinner").hide(),a(".wpum-ajax-done-message").hide(),a("#wpum-restore-default-fields").after('<span id="wpum-spinner" class="spinner wpum-spinner"></span>')},success:function(b){a("#wpum-restore-default-fields").after('<p class="wpum-ajax-done-message"> <span class="dashicons dashicons-yes"></span> '+b.data.message+"</p>"),a(".wpum-spinner").hide()},error:function(a){alert(a.responseText)}})})},custom_fields_editor:function(){a(".users_page_wpum-custom-fields-editor td.column-edit a").on("click",function(c){c.preventDefault();var d=a(this).parent().parent(),e=a(this).data("meta"),f=a(this).next().val();a(".users_page_wpum-custom-fields-editor tr").removeClass("editing"),a(".wpum-fields-editor").remove(),a.ajax({type:"POST",dataType:"json",url:wpum_admin_js.ajax,data:{action:"wpum_load_field_editor",field_meta:e,field_nonce:f},beforeSend:function(){var b=a(".wp-list-table").height();a(".wpum-table-loader").css("display","table"),a(".wpum-table-loader").css("height",b),a(d).addClass("editing")},success:function(c){a(".wpum-table-loader").hide(),a(".users_page_wpum-custom-fields-editor tbody").sortable("disable"),a(c).insertAfter(d),a("html, body").animate({scrollTop:a(".wpum-fields-editor").offset().top},800),a("#delete-action a").on("click",function(b){return b.preventDefault(),a(d).removeClass("editing"),a(".wpum-fields-editor").remove(),a(".users_page_wpum-custom-fields-editor tbody").sortable("enable"),a("html, body").animate({scrollTop:a(d).offset().top},800),!1}),a(".wpum-fields-editor form").on("submit",function(c){c.preventDefault();var d=a(this).find("#_wpnonce").val();a(this).find(":checkbox:not(:checked)").attr("value",!1);var f=a(this).serializeJSON({checkboxUncheckedValue:"false"});b.update_custom_field(f,d,e)})},error:function(b){a(".wpum-table-loader").hide(),alert(b.responseText)}})})},update_custom_field:function(b,c,d){a.ajax({type:"POST",dataType:"json",url:wpum_admin_js.ajax,data:{action:"wpum_update_single_field",update_nonce:c,field:d,options:b},beforeSend:function(){},success:function(){},error:function(a){alert(a.responseText)}})}};b.init()});